%% Rotman Lens Linear Array Factor Calculator
clc
clear all
close all

% First, replace the line below with the data from HFSS
S(1,:,:) = [   -9.307302E-002 +    1.706382E-002i,    8.029870E-003 -    3.970841E-002i,    7.314898E-002 -    6.173086E-002i,   -1.087502E-001 -    7.084788E-002i,    1.834017E-002 +    1.269314E-001i,    1.975015E-001 +    1.093621E-001i,    1.298014E-001 -    1.740908E-001i,   -1.642464E-001 +    8.372238E-002i,    4.980640E-002 -    2.543950E-001i,   -3.142719E-002 +    2.440090E-001i,   -1.076712E-002 -    2.808241E-001i,    1.927448E-001 -    3.402970E-001i,    2.613914E-001 -    2.299617E-001i,    2.330675E-001 +    2.646735E-001i;   8.029870E-003 -    3.970841E-002i,   -1.792349E-001 -    1.290666E-001i,    3.891344E-003 -    4.785905E-002i,    6.359048E-002 +    1.210946E-001i,    9.702793E-003 -    2.180192E-001i,   -1.596918E-001 +    1.589730E-001i,    2.227466E-001 +    1.769003E-001i,    2.128181E-001 +    2.052690E-001i,   -1.462236E-001 +    1.639714E-001i,   -1.166722E-002 -    2.010149E-001i,    6.547171E-002 +    1.133171E-001i,    2.826737E-001 -    1.870637E-001i,    2.537668E-001 -    1.700680E-001i,    2.690401E-001 -    2.071540E-001i;   7.314898E-002 -    6.173086E-002i,    3.891344E-003 -    4.785905E-002i,   -1.195802E-001 +    4.729912E-003i,   -1.291484E-002 -    2.986599E-001i,   -4.740317E-002 +    2.553674E-001i,    4.879770E-002 -    2.308944E-001i,   -1.506354E-001 +    7.034210E-002i,    1.512552E-001 -    1.600916E-001i,    2.027170E-001 +    9.623268E-002i,    1.903243E-002 +    1.183251E-001i,   -1.095008E-001 -    6.193558E-002i,    2.135341E-001 +    2.839297E-001i,    2.546144E-001 -    2.132687E-001i,    2.014597E-001 -    3.439641E-001i;  -1.087502E-001 -    7.084788E-002i,    6.359048E-002 +    1.210946E-001i,   -1.291484E-002 -    2.986599E-001i,   -2.641993E-001 +    1.997353E-001i,    2.197042E-001 -    1.248955E-001i,   -5.600590E-002 +    7.857963E-003i,   -2.681969E-002 -    9.972013E-002i,    1.860290E-001 -    3.060487E-001i,    1.659210E-001 -    2.095372E-001i,    2.021386E-002 +    2.564874E-002i,    1.981368E-001 +    1.377336E-001i,   -1.722908E-001 +    1.296859E-002i,    2.374496E-001 +    1.930816E-001i,    1.728765E-001 -    1.560772E-001i;   1.834017E-002 +    1.269314E-001i,    9.702793E-003 -    2.180192E-001i,   -4.740317E-002 +    2.553674E-001i,    2.197042E-001 -    1.248955E-001i,   -1.412915E-001 -    1.231776E-001i,   -8.348007E-002 +    3.457726E-002i,    1.630415E-003 -    2.299273E-002i,    1.277392E-001 -    1.592742E-001i,    2.606066E-001 -    4.462438E-001i,    2.130270E-001 -    1.343819E-001i,    1.492960E-002 +    2.496473E-002i,    2.800668E-002 -    1.095234E-001i,   -1.709106E-001 +    1.496276E-001i,    2.473563E-001 +    8.607314E-003i;   1.975015E-001 +    1.093621E-001i,   -1.596918E-001 +    1.589730E-001i,    4.879770E-002 -    2.308944E-001i,   -5.600590E-002 +    7.857963E-003i,   -8.348007E-002 +    3.457726E-002i,   -7.197160E-002 -    1.458972E-001i,    1.367278E-001 +    4.873413E-002i,    8.786418E-002 -    4.459537E-002i,    8.978418E-002 -    6.720196E-002i,    2.852811E-001 -    4.485455E-001i,    1.873427E-001 -    1.840637E-001i,   -5.861562E-002 +    1.109835E-001i,    6.697157E-003 -    2.348492E-001i,   -2.356583E-002 +    2.559263E-001i;   1.298014E-001 -    1.740908E-001i,    2.227466E-001 +    1.769003E-001i,   -1.506354E-001 +    7.034210E-002i,   -2.681969E-002 -    9.972013E-002i,    1.630415E-003 -    2.299273E-002i,    1.367278E-001 +    4.873413E-002i,   -3.310402E-001 +    2.840410E-002i,    1.842996E-001 +    3.190196E-001i,    8.203355E-002 -    4.612692E-002i,    1.173063E-001 -    1.734742E-001i,    2.062195E-001 -    2.955052E-001i,    8.564850E-002 -    2.049568E-001i,    6.218929E-002 +    1.472264E-001i,   -1.740364E-001 -    1.429189E-001i;  -1.642464E-001 +    8.372238E-002i,    2.128181E-001 +    2.052690E-001i,    1.512552E-001 -    1.600916E-001i,    1.860290E-001 -    3.060487E-001i,    1.277392E-001 -    1.592742E-001i,    8.786418E-002 -    4.459537E-002i,    1.842996E-001 +    3.190196E-001i,   -3.120432E-001 -    1.898426E-002i,    1.274825E-001 +    7.371755E-002i,    6.752992E-003 -    4.024696E-002i,   -1.780901E-002 -    9.692791E-002i,   -1.518506E-001 -    1.685370E-001i,    3.246756E-002 +    1.261621E-001i,    9.908626E-002 -    2.107659E-001i;   4.980640E-002 -    2.543950E-001i,   -1.462236E-001 +    1.639714E-001i,    2.027170E-001 +    9.623268E-002i,    1.659210E-001 -    2.095372E-001i,    2.606066E-001 -    4.462438E-001i,    8.978418E-002 -    6.720196E-002i,    8.203355E-002 -    4.612692E-002i,    1.274825E-001 +    7.371755E-002i,   -4.805458E-002 -    1.652728E-001i,   -8.622650E-002 +    3.199999E-002i,   -5.918306E-002 +    2.077548E-002i,   -2.937503E-002 +    2.632492E-001i,    9.025467E-003 -    2.170419E-001i,   -6.520783E-002 +    1.106610E-001i;  -3.142719E-002 +    2.440090E-001i,   -1.166722E-002 -    2.010149E-001i,    1.903243E-002 +    1.183251E-001i,    2.021386E-002 +    2.564874E-002i,    2.130270E-001 -    1.343819E-001i,    2.852811E-001 -    4.485455E-001i,    1.173063E-001 -    1.734742E-001i,    6.752992E-003 -    4.024696E-002i,   -8.622650E-002 +    3.199999E-002i,   -1.537524E-001 -    6.912330E-002i,    2.348065E-001 -    1.398453E-001i,    2.422504E-001 +    2.571807E-002i,   -1.547139E-001 +    1.365010E-001i,    2.738099E-002 -    9.960317E-002i;  -1.076712E-002 -    2.808241E-001i,    6.547171E-002 +    1.133171E-001i,   -1.095008E-001 -    6.193558E-002i,    1.981368E-001 +    1.377336E-001i,    1.492960E-002 +    2.496473E-002i,    1.873427E-001 -    1.840637E-001i,    2.062195E-001 -    2.955052E-001i,   -1.780901E-002 -    9.692791E-002i,   -5.918306E-002 +    2.077548E-002i,    2.348065E-001 -    1.398453E-001i,   -3.242066E-001 +    1.512647E-001i,    1.902039E-001 -    1.367897E-001i,    2.168361E-001 +    1.944733E-001i,   -1.661720E-001 +    1.125041E-002i;   1.927448E-001 -    3.402970E-001i,    2.826737E-001 -    1.870637E-001i,    2.135341E-001 +    2.839297E-001i,   -1.722908E-001 +    1.296859E-002i,    2.800668E-002 -    1.095234E-001i,   -5.861562E-002 +    1.109835E-001i,    8.564850E-002 -    2.049568E-001i,   -1.518506E-001 -    1.685370E-001i,   -2.937503E-002 +    2.632492E-001i,    2.422504E-001 +    2.571807E-002i,    1.902039E-001 -    1.367897E-001i,   -1.474242E-001 +    3.255470E-002i,   -1.238286E-003 -    1.017351E-001i,    1.414814E-001 -    1.984999E-002i;   2.613914E-001 -    2.299617E-001i,    2.537668E-001 -    1.700680E-001i,    2.546144E-001 -    2.132687E-001i,    2.374496E-001 +    1.930816E-001i,   -1.709106E-001 +    1.496276E-001i,    6.697157E-003 -    2.348492E-001i,    6.218929E-002 +    1.472264E-001i,    3.246756E-002 +    1.261621E-001i,    9.025467E-003 -    2.170419E-001i,   -1.547139E-001 +    1.365010E-001i,    2.168361E-001 +    1.944733E-001i,   -1.238286E-003 -    1.017351E-001i,   -1.312287E-001 -    8.312365E-002i,   -2.115395E-002 -    8.772202E-002i;   2.330675E-001 +    2.646735E-001i,    2.690401E-001 -    2.071540E-001i,    2.014597E-001 -    3.439641E-001i,    1.728765E-001 -    1.560772E-001i,    2.473563E-001 +    8.607314E-003i,   -2.356583E-002 +    2.559263E-001i,   -1.740364E-001 -    1.429189E-001i,    9.908626E-002 -    2.107659E-001i,   -6.520783E-002 +    1.106610E-001i,    2.738099E-002 -    9.960317E-002i,   -1.661720E-001 +    1.125041E-002i,    1.414814E-001 -    1.984999E-002i,   -2.115395E-002 -    8.772202E-002i,   -1.405208E-001 +    3.759855E-002i];
Nb = 3;
Na = 3; 
Nd = 8;
N = Nb+Na+Nd;
%Adjust it to only be a 2 dimensional matrix since we only care about the
%first mode

for i=1:N
    S_Param(i,:)= S(1,i,:);
end 

% Identify row of interests for excitation to determine relative phase
% differences and thereby calculate alpha. If there are N total ports, Nb
% Beam ports and Na array ports then ports 1-Nb will be excitations and ports
% N - M will be array ports. That means the numbers in between are dummy
% ports Nd
% This is the convention I will use moving forward

% Now extract the phase information from the S-Parameters of the array
% ports based on port 1 excitation

S_Param_alpha = S_Param(:,1);
for i=0:Na-1
    S_a(1,i+1) = S_Param_alpha(N-i,1);
end
% Determine the phase of each
for i=1:Na
    a_phase(1,i) = angle(S_a(1,i));
end
% Determine the mag of each
for i=1:Na
    S_mag(1,i) = abs(S_a(1,i));
end
% Renormalize relative phase and set phase of last element to zero
for i=1:Na
    a_phase_r(1,i) = a_phase(1,i) - a_phase(1,1);
end

% Calculate and plot array factor
theta = linspace(0,2*pi,5000);
c=299792458;  
f=5.9e9;         
lambda0=c/f;
Beta = 2*pi/lambda0;
Beta_d = 2*pi/lambda0*0.5*lambda0;

for n = 0:Na-1
    for i = 1:size(theta,2)
        psi(n+1,i) = n*(Beta_d*cos(theta(i))+ a_phase_r(n+1));
    end
end

for n = 0:Na-1
    for i = 1:size(theta,2)
        AF(n+1,i) = S_mag(1,n+1)*exp(-1i*psi(n+1,i));
    end
end
AF = abs(sum(AF(1:Na,:)));

figure;
polar(theta, AF);

