% Matlab m-File exported from HFSS2016.0.0 
% Note: In three-dimensional arrays, like S(i,j,k), the first index corresponds to the frequency.
%       So, S(N,j,k) is an S(j,k) matrix for frequency N.
clear all 
clc
close all

f = zeros(1,1);
S = zeros(1,10,10);

f = [5900000000 ];
S(1,:,:) = [   -3.242946E-001 -    1.600625E-001i,    5.860691E-002 +    5.884514E-002i,    6.434367E-002 +    5.477761E-002i,   -1.620514E-001 +    4.144952E-002i,   -3.835713E-002 -    1.038655E-001i,   -1.554972E-001 +    4.191087E-002i,   -4.082557E-002 -    1.084291E-001i,    1.293015E-001 -    2.863961E-001i,    1.188118E-001 -    3.865126E-001i,    1.242153E-001 -    3.952787E-001i;   5.860739E-002 +    5.884490E-002i,    1.703841E-001 -    7.422426E-002i,   -3.260717E-001 +    8.870880E-005i,    1.011021E-001 -    9.292793E-003i,   -1.677342E-002 +    5.359124E-002i,    3.951214E-002 -    1.294859E-001i,    1.639714E-001 +    1.015978E-001i,   -3.909665E-002 -    4.493573E-001i,   -6.070614E-002 -    1.377149E-001i,    2.616747E-001 +    3.781858E-003i;   6.434296E-002 +    5.477698E-002i,   -3.260722E-001 +    8.862626E-005i,    1.869060E-001 -    4.797113E-002i,    4.554293E-002 -    1.313319E-001i,    1.526019E-001 +    1.037825E-001i,    9.734067E-002 -    3.325746E-003i,   -2.630295E-002 +    5.245959E-002i,   -3.108801E-002 -    4.476308E-001i,    2.580410E-001 -    2.249158E-003i,   -6.526759E-002 -    1.190954E-001i;  -1.620514E-001 +    4.144897E-002i,    1.011017E-001 -    9.292952E-003i,    4.554225E-002 -    1.313325E-001i,   -2.111926E-002 -    1.227026E-001i,    3.453348E-002 +    2.798127E-001i,    3.045219E-001 +    1.146893E-001i,    2.852564E-001 -    2.853074E-001i,   -1.142823E-001 +    1.260697E-001i,    1.010906E-001 -    2.499913E-002i,    1.732655E-001 -    1.285025E-001i;  -3.835731E-002 -    1.038653E-001i,   -1.677322E-002 +    5.359106E-002i,    1.526020E-001 +    1.037826E-001i,    3.453392E-002 +    2.798125E-001i,   -1.744451E-001 -    3.658040E-001i,    3.002434E-001 -    3.017881E-001i,    2.718220E-001 -    2.430399E-001i,    4.011270E-004 -    9.875308E-002i,   -1.496843E-002 +    7.056348E-002i,   -5.102273E-002 +    1.288075E-001i;  -1.554972E-001 +    4.191115E-002i,    3.951246E-002 -    1.294866E-001i,    9.734019E-002 -    3.325998E-003i,    3.045218E-001 +    1.146889E-001i,    3.002435E-001 -    3.017881E-001i,   -5.209743E-002 -    8.406243E-002i,    5.039337E-002 +    2.664894E-001i,   -1.035477E-001 +    1.223093E-001i,    1.832543E-001 -    1.281034E-001i,    7.398506E-002 -    3.112216E-002i;  -4.082536E-002 -    1.084292E-001i,    1.639712E-001 +    1.015977E-001i,   -2.630303E-002 +    5.245956E-002i,    2.852565E-001 -    2.853075E-001i,    2.718219E-001 -    2.430399E-001i,    5.039303E-002 +    2.664895E-001i,   -2.198210E-001 -    3.677523E-001i,   -3.165026E-003 -    1.077870E-001i,   -4.188588E-002 +    1.277991E-001i,   -2.402579E-002 +    8.742006E-002i;   1.293013E-001 -    2.863963E-001i,   -3.909666E-002 -    4.493575E-001i,   -3.108845E-002 -    4.476307E-001i,   -1.142820E-001 +    1.260694E-001i,    4.010356E-004 -    9.875286E-002i,   -1.035473E-001 +    1.223093E-001i,   -3.165190E-003 -    1.077869E-001i,   -5.407183E-002 -    2.149397E-001i,   -5.689324E-002 +    8.172679E-002i,   -6.956486E-002 +    8.668955E-002i;   1.188116E-001 -    3.865129E-001i,   -6.070657E-002 -    1.377146E-001i,    2.580410E-001 -    2.249507E-003i,    1.010907E-001 -    2.499889E-002i,   -1.496889E-002 +    7.056350E-002i,    1.832546E-001 -    1.281033E-001i,   -4.188612E-002 +    1.277995E-001i,   -5.689326E-002 +    8.172685E-002i,   -3.168308E-001 +    5.543264E-004i,    1.964047E-001 -    2.353852E-001i;   1.242152E-001 -    3.952789E-001i,    2.616746E-001 +    3.782345E-003i,   -6.526787E-002 -    1.190956E-001i,    1.732655E-001 -    1.285020E-001i,   -5.102313E-002 +    1.288073E-001i,    7.398517E-002 -    3.112197E-002i,   -2.402602E-002 +    8.742025E-002i,   -6.956489E-002 +    8.668979E-002i,    1.964048E-001 -    2.353851E-001i,   -3.101585E-001 -    8.479178E-003i];

for i=1:10
    S_Param(i,:)= S(1,i,:);
end 
% Identify row of interests for excitation to determine relative phase
% differences and thereby calculate alpha. In this instance port 9 is the
% excitation and ports 1,2,3 are the antenna ports

S_Param_alpha = S_Param(9,:);
S19 = S_Param_alpha(1,1);
S29 = S_Param_alpha(1,2);
S39 = S_Param_alpha(1,3);

S19_phase = angle(S19);
S29_phase = angle(S29);
S39_phase = angle(S39);
% adujust for relative phase with respect to port 3 (closest element with
% respect to excited port 9)

S29_p_r = S29_phase - S39_phase;
S19_p_r = S19_phase - S39_phase;
S39_p_r = 0;
S_p_r = [S39_p_r S29_p_r S19_p_r];



% Calculate and plot 3 element array factor
theta = linspace(0,2*pi,5000);
N=3;
v0=299792458;  
f=5.9e9;         
lambda0=v0/f;
Beta = 2*pi/lambda0;
Beta_d = 2*pi/lambda0*0.5*lambda0;

for n = 0:N-1
    for i = 1:size(theta,2)
        psi(n+1,i) = n*(Beta_d*cos(theta(i))+ S_p_r(n+1));
    end
end

for n = 0:N-1
    for i = 1:size(theta,2)
        AF(n+1,i) = exp(-1i*psi(n+1,i));
    end
end
AF = abs(sum(AF(1:N,:))/N);

figure;
polar(theta, AF);
